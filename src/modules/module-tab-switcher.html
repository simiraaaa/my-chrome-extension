<module-tab-switcher>
  <form onsubmit="{submit}" class="f flex-column s-full" onkeydown="{selectUpDown}">
    <input ref="search" type="search" oninput="{delaySearch}" class="input w-full fs12 flex-fixed letter-spacing-1">
    <div class="overflow-scroll s-full" ref="scroll">
      <item-tab each="{item, i in items}" item="{item}" onclick="{switchTab}" selected="{i === parent.selectIndex}"></item-tab>
    </div>
  </form>
  <style type="less">
    :scope {
      display: block;
    }
  </style>
  <script>

    this.selectIndex = 0;

    this.on('mount', () => {
      this.search();
      this.refs.search.focus();
    });

    this.submit = (e) => {
      e.preventDefault();
      // 選択しているアイテムをクリックする
      var item = this.items[this.selectIndex];
      if (item) {
        this.switchTab({item:{item}});
      }
    };

    this.filterItems = (items, word) => {
      if (!word) return [items];
      var wordLowerCase = word.toLowerCase();
      var reg = util.reg.createSearch(word, 'i');
      var partMatchItems = [];
      var aimaiMatchItems = [];
      items.forEach(item => {
        var urlIndex = item.url.indexOf(wordLowerCase);
        var titleIndex = item.title.toLowerCase().indexOf(wordLowerCase);
        // 部分一致
        if (urlIndex !== -1 || titleIndex !== -1) {
          partMatchItems.push({
            item,
            urlIndex: urlIndex === -1 ? Infinity : urlIndex,
            titleIndex: titleIndex === -1 ? Infinity : titleIndex,
          });
        }
        else {
          var urlTest = reg.test(item.url);
          var titleTest = reg.test(item.title);
          // 曖昧一致
          if (urlTest || titleTest) {
            aimaiMatchItems.push({
              item,
              urlTest,
              titleTest,
            });
          }
        }
      });
      return [
        partMatchItems.sort((a, b) => {
          if (a.urlIndex === b.urlIndex) {
            return a.titleIndex - b.titleIndex;
          }
          else {
            return a.urlIndex - b.urlIndex;
          }
        }).map(item => item.item),
        aimaiMatchItems.sort((a, b) => {
          // 両方マッチしてるやつが上
          var aCount = +a.titleTest + a.urlTest;
          var bCount = +b.titleTest + b.urlTest;
          return bCount - aCount;
        }).map(item => item.item)
      ];
    };

    this.search = async () => {
      var items = await util.tabs.getAllByAllWindow();
      var v = this.refs.search.value;
      if (v) {
        var results = [];
        v.split(/\s+/).reduce((filteredItems, word) => {
          var results = [];
          filteredItems.forEach((items) => {
            this.filterItems(items, word).forEach(items => {
              if (items.length > 0) {
                results.push(items);
              }
            });
          });
          return results;
        }, [items]).forEach(items => items.forEach(item => results.push(item)));
        items = results;
      }
      this.items = items;
      this.selectIndex = 0;
      this.update();
      this.refs.scroll.scrollTop = 0;
    };

    this.delaySearch = _.debounce(this.search, 150);

    this.switchTab = (e) => {
      util.tabs.activate(e.item.item);
      util.close();
    };

    this.selectUpDown = (e) => {
      if (e.keyCode === 38) {
        this.selectIndex = Math.max(0, this.selectIndex - 1);
        e.preventDefault();
      }
      else if (e.keyCode === 40) {
        this.selectIndex = Math.min(this.items.length - 1, this.selectIndex + 1);
        e.preventDefault();
      }
      else {
        e.preventUpdate = true;
      }
    };

  </script>
</module-tab-switcher>